import * as vscode from "vscode";

const HELP_BASE = "https://help.qlik.com/en-US/sense/November2025/csh/client/scriptsyntax.";

// Map: lowercase keyword -> original case for URL
const KEYWORDS: Map<string, string> = new Map([
  ["acos", "Acos"],
  ["acosh", "Acosh"],
  ["addmonths", "AddMonths"],
  ["addyears", "AddYears"],
  ["age", "Age"],
  ["alias", "Alias"],
  ["alt", "Alt"],
  ["applycodepage", "ApplyCodepage"],
  ["applymap", "ApplyMap"],
  ["argb", "ARGB"],
  ["asin", "Asin"],
  ["asinh", "Asinh"],
  ["atan", "Atan"],
  ["atan2", "Atan2"],
  ["atanh", "Atanh"],
  ["attribute", "Attribute"],
  ["author", "Author"],
  ["autonumber", "Autonumber"],
  ["autonumberhash128", "AutoNumberHash128"],
  ["autonumberhash256", "AutoNumberHash256"],
  ["avg", "Avg"],
  ["bdi", "BDI"],
  ["betadensity", "BetaDensity"],
  ["betadist", "BetaDist"],
  ["betainv", "BetaInv"],
  ["binary", "Binary"],
  ["binomdist", "BinomDist"],
  ["binomfrequency", "BinomFrequency"],
  ["binominv", "BinomInv"],
  ["bitcount", "BitCount"],
  ["black", "Black"],
  ["blackandschole", "BlackAndSchole"],
  ["blue", "Blue"],
  ["brown", "Brown"],
  ["call", "Call"],
  ["capitalize", "Capitalize"],
  ["case", "Case"],
  ["ceil", "Ceil"],
  ["chi2test_chi2", "Chi2Test_Chi2"],
  ["chi2test_df", "Chi2Test_DF"],
  ["chi2test_p", "Chi2Test_p"],
  ["chidensity", "ChiDensity"],
  ["chidist", "ChiDist"],
  ["chiinv", "ChiInv"],
  ["chr", "Chr"],
  ["class", "Class"],
  ["clientplatform", "ClientPlatform"],
  ["coalesce", "Coalesce"],
  ["color", "Color"],
  ["colormaphue", "ColorMapHue"],
  ["colormapjet", "ColorMapJet"],
  ["colormix1", "ColorMix1"],
  ["colormix2", "ColorMix2"],
  ["combin", "Combin"],
  ["comment", "Comment"],
  ["computername", "ComputerName"],
  ["concat", "Concat"],
  ["connect", "Connect"],
  ["connect32", "Connect32"],
  ["connect64", "Connect64"],
  ["connectstring", "ConnectString"],
  ["converttolocaltime", "ConvertToLocalTime"],
  ["correl", "Correl"],
  ["cos", "Cos"],
  ["cosh", "Cosh"],
  ["count", "Count"],
  ["countregex", "CountRegEx"],
  ["countregexi", "CountRegExI"],
  ["create", "Create"],
  ["create relationship", "Create Relationship"],
  ["customconnect", "CustomConnect"],
  ["cyan", "Cyan"],
  ["darkgray", "DarkGray"],
  ["date", "Date"],
  ["date#", "Date#"],
  ["day", "Day"],
  ["dayend", "DayEnd"],
  ["daylightsaving", "DaylightSaving"],
  ["dayname", "DayName"],
  ["daynumberofquarter", "DayNumberOfQuarter"],
  ["daynumberofyear", "DayNumberOfYear"],
  ["daystart", "DayStart"],
  ["declare", "Declare"],
  ["default", "Default"],
  ["derive", "Derive"],
  ["dimension", "Dimension"],
  ["direct", "DIRECT"],
  ["directory", "Directory"],
  ["disconnect", "DisConnect"],
  ["div", "Div"],
  ["do", "Do"],
  ["documentname", "DocumentName"],
  ["documentpath", "DocumentPath"],
  ["documenttitle", "DocumentTitle"],
  ["drop", "Drop"],
  ["drop field", "Drop Field"],
  ["drop relationship", "Drop Relationship"],
  ["drop table", "Drop Table"],
  ["dual", "Dual"],
  ["e", "e"],
  ["elapsedseconds", "ElapsedSeconds"],
  ["else", "Else"],
  ["elseif", "ElseIf"],
  ["emptyisnull", "EmptyIsNull"],
  ["end", "End"],
  ["endif", "EndIf"],
  ["endsub", "EndSub"],
  ["endswitch", "EndSwitch"],
  ["engineversion", "EngineVersion"],
  ["evaluate", "Evaluate"],
  ["even", "Even"],
  ["execute", "Execute"],
  ["exists", "Exists"],
  ["exit", "Exit"],
  ["exp", "Exp"],
  ["extractregex", "ExtractRegEx"],
  ["extractregexgroup", "ExtractRegExGroup"],
  ["extractregexgroupi", "ExtractRegExGroupI"],
  ["extractregexi", "ExtractRegExI"],
  ["fabs", "fAbs"],
  ["fact", "Fact"],
  ["false", "False"],
  ["fastmatch", "FastMatch"],
  ["fdensity", "FDensity"],
  ["fdist", "FDist"],
  ["fieldelemno", "FieldElemNo"],
  ["fieldindex", "FieldIndex"],
  ["fieldname", "FieldName"],
  ["fieldnumber", "FieldNumber"],
  ["fieldvalue", "FieldValue"],
  ["fieldvaluecount", "FieldValueCount"],
  ["filebasename", "FileBaseName"],
  ["filedir", "FileDir"],
  ["fileextension", "FileExtension"],
  ["filename", "FileName"],
  ["filepath", "FilePath"],
  ["filesize", "FileSize"],
  ["filetime", "FileTime"],
  ["findoneof", "FindOneOf"],
  ["finv", "FInv"],
  ["firstsortedvalue", "FirstSortedValue"],
  ["firstvalue", "FirstValue"],
  ["firstworkdate", "FirstWorkDate"],
  ["floor", "Floor"],
  ["flushlog", "FlushLog"],
  ["fmod", "fMod"],
  ["for", "For"],
  ["force", "force"],
  ["frac", "Frac"],
  ["fractile", "Fractile"],
  ["fractileexc", "FractileExc"],
  ["fv", "FV"],
  ["gammadensity", "GammaDensity"],
  ["gammadist", "GammaDist"],
  ["gammainv", "GammaInv"],
  ["geoaggrgeometry", "GeoAggrGeometry"],
  ["geoboundingbox", "GeoBoundingBox"],
  ["geocountvertex", "GeoCountVertex"],
  ["geogetboundingbox", "GeoGetBoundingBox"],
  ["geogetpolygoncenter", "GeoGetPolygonCenter"],
  ["geoinvprojectgeometry", "GeoInvProjectGeometry"],
  ["geomakepoint", "GeoMakePoint"],
  ["geoproject", "GeoProject"],
  ["geoprojectgeometry", "GeoProjectGeometry"],
  ["georeducegeometry", "GeoReduceGeometry"],
  ["getcollationlocale", "GetCollationLocale"],
  ["getdatamodelhash", "GetDataModelHash"],
  ["getfolderpath", "GetFolderPath"],
  ["getobjectfield", "GetObjectField"],
  ["getsysattr", "GetSysAttr"],
  ["getuserattr", "GetUserAttr"],
  ["gmt", "GMT"],
  ["green", "Green"],
  ["hash128", "Hash128"],
  ["hash160", "Hash160"],
  ["hash256", "Hash256"],
  ["hcnorows", "HCNoRows"],
  ["hcvalue", "HCValue"],
  ["hour", "Hour"],
  ["hsl", "HSL"],
  ["if", "If"],
  ["import", "IMPORT"],
  ["inday", "InDay"],
  ["indaytotime", "InDayToTime"],
  ["index", "Index"],
  ["indexregex", "IndexRegEx"],
  ["indexregexgroup", "IndexRegExGroup"],
  ["indexregexgroupi", "IndexRegExGroupI"],
  ["indexregexi", "IndexRegExI"],
  ["inlunarweek", "InLunarWeek"],
  ["inlunarweektodate", "InLunarWeekToDate"],
  ["inmonth", "InMonth"],
  ["inmonths", "InMonths"],
  ["inmonthstodate", "InMonthsToDate"],
  ["inmonthtodate", "InMonthToDate"],
  ["inputfield", "InputField"],
  ["inquarter", "InQuarter"],
  ["inquartertodate", "InQuarterToDate"],
  ["interval", "Interval"],
  ["interval#", "Interval#"],
  ["inweek", "InWeek"],
  ["inweektodate", "InWeekToDate"],
  ["inyear", "InYear"],
  ["inyeartodate", "InYearToDate"],
  ["irr", "Irr"],
  ["isjson", "IsJson"],
  ["isnull", "IsNull"],
  ["isnum", "IsNum"],
  ["ispartialreload", "IsPartialReload"],
  ["isregex", "IsRegEx"],
  ["isregexi", "IsRegExI"],
  ["istext", "IsText"],
  ["iterno", "IterNo"],
  ["jsonarray", "JsonArray"],
  ["jsonget", "JsonGet"],
  ["jsonobject", "JsonObject"],
  ["jsonset", "JsonSet"],
  ["jsonsetex", "JsonSetEx"],
  ["keepchar", "KeepChar"],
  ["kurtosis", "Kurtosis"],
  ["lastvalue", "LastValue"],
  ["lastworkdate", "LastWorkDate"],
  ["left", "Left"],
  ["len", "Len"],
  ["let", "Let"],
  ["levenshteindist", "LevenshteinDist"],
  ["lib", "LIB"],
  ["lightblue", "LightBlue"],
  ["lightcyan", "LightCyan"],
  ["lightgray", "LightGray"],
  ["lightgreen", "LightGreen"],
  ["lightmagenta", "LightMagenta"],
  ["lightred", "LightRed"],
  ["linest_b", "LinEst_B"],
  ["linest_df", "LinEst_DF"],
  ["linest_f", "LinEst_F"],
  ["linest_m", "LinEst_M"],
  ["linest_r2", "LinEst_R2"],
  ["linest_seb", "LinEst_SEB"],
  ["linest_sem", "LinEst_SEM"],
  ["linest_sey", "LinEst_SEY"],
  ["linest_ssreg", "LinEst_SSReg"],
  ["linest_ssresid", "LinEst_SSResid"],
  ["load", "Load"],
  ["localtime", "LocalTime"],
  ["log", "Log"],
  ["log10", "Log10"],
  ["lookup", "Lookup"],
  ["loop", "Loop"],
  ["loosen", "Loosen"],
  ["lower", "Lower"],
  ["ltrim", "LTrim"],
  ["lunarweekend", "LunarWeekEnd"],
  ["lunarweekname", "LunarWeekName"],
  ["lunarweekstart", "LunarWeekStart"],
  ["magenta", "Magenta"],
  ["makedate", "MakeDate"],
  ["maketime", "MakeTime"],
  ["makeweekdate", "MakeWeekDate"],
  ["map", "Map"],
  ["mapsubstring", "MapSubString"],
  ["match", "Match"],
  ["matchregex", "MatchRegEx"],
  ["matchregexi", "MatchRegExI"],
  ["max", "Max"],
  ["maxstring", "MaxString"],
  ["measure", "Measure"],
  ["median", "Median"],
  ["mid", "Mid"],
  ["min", "Min"],
  ["minstring", "MinString"],
  ["minute", "Minute"],
  ["missingcount", "MissingCount"],
  ["mixmatch", "MixMatch"],
  ["mod", "Mod"],
  ["mode", "Mode"],
  ["money", "Money"],
  ["money#", "Money#"],
  ["month", "Month"],
  ["monthend", "MonthEnd"],
  ["monthname", "MonthName"],
  ["monthsend", "MonthsEnd"],
  ["monthsname", "MonthsName"],
  ["monthsstart", "MonthsStart"],
  ["monthstart", "MonthStart"],
  ["networkdays", "NetWorkDays"],
  ["next", "Next"],
  ["nooffields", "NoOfFields"],
  ["noofrows", "NoOfRows"],
  ["nooftables", "NoOfTables"],
  ["normdist", "NormDist"],
  ["norminv", "NormInv"],
  ["now", "Now"],
  ["nper", "nPer"],
  ["npv", "Npv"],
  ["null", "Null"],
  ["nullasnull", "NullAsNull"],
  ["nullasvalue", "NullAsValue"],
  ["nullcount", "NullCount"],
  ["num", "Num"],
  ["num#", "Num#"],
  ["numavg", "NumAvg"],
  ["numcount", "NumCount"],
  ["numericcount", "NumericCount"],
  ["nummax", "NumMax"],
  ["nummin", "NumMin"],
  ["numsum", "NumSum"],
  ["odd", "Odd"],
  ["only", "Only"],
  ["ord", "Ord"],
  ["osuser", "OSUser"],
  ["peek", "Peek"],
  ["permut", "Permut"],
  ["pi", "Pi"],
  ["pick", "Pick"],
  ["pmt", "Pmt"],
  ["poissondensity", "PoissonDensity"],
  ["poissondist", "PoissonDist"],
  ["poissonfrequency", "PoissonFrequency"],
  ["poissoninv", "PoissonInv"],
  ["pow", "Pow"],
  ["previous", "Previous"],
  ["productversion", "ProductVersion"],
  ["purgechar", "PurgeChar"],
  ["pv", "PV"],
  ["qliktechblue", "QlikTechBlue"],
  ["qliktechgray", "QlikTechGray"],
  ["qlikviewversion", "QlikViewVersion"],
  ["qsl", "QSL"],
  ["qualify", "Qualify"],
  ["quarterend", "QuarterEnd"],
  ["quartername", "QuarterName"],
  ["quarterstart", "QuarterStart"],
  ["qvdcreatetime", "QvdCreateTime"],
  ["qvdfieldname", "QvdFieldName"],
  ["qvdnooffields", "QvdNoOfFields"],
  ["qvdnoofrecords", "QvdNoOfRecords"],
  ["qvdtablename", "QvdTableName"],
  ["qvuser", "QVUser"],
  ["rand", "Rand"],
  ["rangeavg", "RangeAvg"],
  ["rangecorrel", "RangeCorrel"],
  ["rangecount", "RangeCount"],
  ["rangefractile", "RangeFractile"],
  ["rangefractileexc", "RangeFractileExc"],
  ["rangeirr", "RangeIrr"],
  ["rangekurtosis", "RangeKurtosis"],
  ["rangemax", "RangeMax"],
  ["rangemaxstring", "RangeMaxString"],
  ["rangemin", "RangeMin"],
  ["rangeminstring", "RangeMinString"],
  ["rangemissingcount", "RangeMissingCount"],
  ["rangemode", "RangeMode"],
  ["rangenpv", "RangeNpv"],
  ["rangenullcount", "RangeNullCount"],
  ["rangenumericcount", "RangeNumericCount"],
  ["rangeonly", "RangeOnly"],
  ["rangeskew", "RangeSkew"],
  ["rangestdev", "RangeStDev"],
  ["rangesum", "RangeSum"],
  ["rangetextcount", "RangeTextCount"],
  ["rangexirr", "RangeXirr"],
  ["rangexnpv", "RangeXnpv"],
  ["rate", "Rate"],
  ["recno", "RecNo"],
  ["red", "Red"],
  ["reloadtime", "ReloadTime"],
  ["rem", "Rem"],
  ["rename", "Rename"],
  ["rename field", "Rename Field"],
  ["rename table", "Rename Table"],
  ["repeat", "Repeat"],
  ["replace", "Replace"],
  ["replaceregex", "ReplaceRegEx"],
  ["replaceregexgroup", "ReplaceRegExGroup"],
  ["replaceregexgroupi", "ReplaceRegExGroupI"],
  ["replaceregexi", "ReplaceRegExI"],
  ["rgb", "RGB"],
  ["right", "Right"],
  ["round", "Round"],
  ["rowno", "RowNo"],
  ["rtrim", "RTrim"],
  ["script", "Script"],
  ["search", "Search"],
  ["second", "Second"],
  ["section", "Section"],
  ["select", "Select"],
  ["set", "Set"],
  ["setdateyear", "SetDateYear"],
  ["setdateyearmonth", "SetDateYearMonth"],
  ["sign", "Sign"],
  ["sin", "Sin"],
  ["sinh", "Sinh"],
  ["skew", "Skew"],
  ["sleep", "Sleep"],
  ["sql", "SQL"],
  ["sqlcolumns", "SQLColumns"],
  ["sqltables", "SQLTables"],
  ["sqltypes", "SQLTypes"],
  ["sqr", "Sqr"],
  ["sqrt", "Sqrt"],
  ["star", "Star"],
  ["stdev", "StDev"],
  ["sterr", "StErr"],
  ["steyx", "StEYX"],
  ["store", "Store"],
  ["sub", "Sub"],
  ["subfield", "SubField"],
  ["subfieldregex", "SubFieldRegEx"],
  ["subfieldregexi", "SubFieldRegExI"],
  ["substringcount", "SubStringCount"],
  ["sum", "Sum"],
  ["switch", "Switch"],
  ["syscolor", "SysColor"],
  ["tablename", "TableName"],
  ["tablenumber", "TableNumber"],
  ["tag", "Tag"],
  ["tan", "Tan"],
  ["tanh", "Tanh"],
  ["tdensity", "TDensity"],
  ["tdist", "TDist"],
  ["text", "Text"],
  ["textbetween", "TextBetween"],
  ["textcount", "TextCount"],
  ["then", "then"],
  ["time", "Time"],
  ["time#", "Time#"],
  ["timestamp", "Timestamp"],
  ["timestamp#", "Timestamp#"],
  ["timezone", "TimeZone"],
  ["tinv", "TInv"],
  ["today", "Today"],
  ["trace", "Trace"],
  ["trim", "Trim"],
  ["true", "True"],
  ["ttest1_conf", "TTest1_Conf"],
  ["ttest1_df", "TTest1_DF"],
  ["ttest1_dif", "TTest1_Dif"],
  ["ttest1_lower", "TTest1_Lower"],
  ["ttest1_sig", "TTest1_Sig"],
  ["ttest1_sterr", "TTest1_StErr"],
  ["ttest1_t", "TTest1_t"],
  ["ttest1_upper", "TTest1_Upper"],
  ["ttest1w_conf", "TTest1w_Conf"],
  ["ttest1w_df", "TTest1w_DF"],
  ["ttest1w_dif", "TTest1w_Dif"],
  ["ttest1w_lower", "TTest1w_Lower"],
  ["ttest1w_sig", "TTest1w_Sig"],
  ["ttest1w_sterr", "TTest1w_StErr"],
  ["ttest1w_t", "TTest1w_t"],
  ["ttest1w_upper", "TTest1w_Upper"],
  ["ttest_conf", "TTest_Conf"],
  ["ttest_df", "TTest_DF"],
  ["ttest_dif", "TTest_Dif"],
  ["ttest_lower", "TTest_Lower"],
  ["ttest_sig", "TTest_Sig"],
  ["ttest_sterr", "TTest_StErr"],
  ["ttest_t", "TTest_t"],
  ["ttest_upper", "TTest_Upper"],
  ["ttestw_conf", "TTestw_Conf"],
  ["ttestw_df", "TTestw_DF"],
  ["ttestw_dif", "TTestw_Dif"],
  ["ttestw_lower", "TTestw_Lower"],
  ["ttestw_sig", "TTestw_Sig"],
  ["ttestw_sterr", "TTestw_StErr"],
  ["ttestw_t", "TTestw_t"],
  ["ttestw_upper", "TTestw_Upper"],
  ["unbounded", "UNBOUNDED"],
  ["unmap", "Unmap"],
  ["unqualify", "Unqualify"],
  ["untag", "Untag"],
  ["until", "until"],
  ["upper", "Upper"],
  ["utc", "UTC"],
  ["week", "Week"],
  ["weekday", "WeekDay"],
  ["weekend", "WeekEnd"],
  ["weekname", "WeekName"],
  ["weekstart", "WeekStart"],
  ["weekyear", "WeekYear"],
  ["while", "while"],
  ["white", "White"],
  ["wildmatch", "WildMatch"],
  ["window", "Window"],
  ["wrank", "WRank"],
  ["xirr", "Xirr"],
  ["xnpv", "Xnpv"],
  ["year", "Year"],
  ["year2date", "Year2Date"],
  ["yearend", "YearEnd"],
  ["yearname", "YearName"],
  ["yearstart", "YearStart"],
  ["yeartodate", "YearToDate"],
  ["yellow", "Yellow"],
  ["ztest_conf", "ZTest_Conf"],
  ["ztest_dif", "ZTest_Dif"],
  ["ztest_lower", "ZTest_Lower"],
  ["ztest_sig", "ZTest_Sig"],
  ["ztest_sterr", "ZTest_StErr"],
  ["ztest_upper", "ZTest_Upper"],
  ["ztest_z", "ZTest_z"],
  ["ztestw_conf", "ZTestw_Conf"],
  ["ztestw_dif", "ZTestw_Dif"],
  ["ztestw_lower", "ZTestw_Lower"],
  ["ztestw_sig", "ZTestw_Sig"],
  ["ztestw_sterr", "ZTestw_StErr"],
  ["ztestw_upper", "ZTestw_Upper"],
  ["ztestw_z", "ZTestw_z"]
]);

class QlikDefinitionProvider implements vscode.DefinitionProvider {
  provideDefinition(
    document: vscode.TextDocument,
    position: vscode.Position
  ): vscode.ProviderResult<vscode.LocationLink[]> {
    const wordRange = document.getWordRangeAtPosition(position, /[A-Za-z_][A-Za-z0-9_#]*/);
    if (!wordRange) return null;

    const word = document.getText(wordRange);
    const originalCase = KEYWORDS.get(word.toLowerCase());
    if (!originalCase) return null;

    return [{
      originSelectionRange: wordRange,
      targetUri: vscode.Uri.parse(HELP_BASE + originalCase),
      targetRange: new vscode.Range(0, 0, 0, 0),
    }];
  }
}

export function activate(context: vscode.ExtensionContext): void {
  context.subscriptions.push(
    vscode.languages.registerDefinitionProvider(
      { language: "qlik", scheme: "file" },
      new QlikDefinitionProvider()
    )
  );
}

export function deactivate(): void {}
